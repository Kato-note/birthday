<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>FINAL ACCESS // QUEST</title>

<style>
  html, body{
    margin:0; padding:0; height:100%;
    overflow:hidden;
    font-family: Arial, sans-serif;
    background:#070814;
    color:#eaf7ff;
  }

  /* layout */
  #app{
    position:fixed; inset:0;
    display:flex;
    flex-direction:column;
    background:
      radial-gradient(1200px 600px at 50% 0%, rgba(255,46,99,0.20), transparent 55%),
      radial-gradient(900px 500px at 80% 40%, rgba(125,255,218,0.15), transparent 60%),
      linear-gradient(180deg, #070814 0%, #05060a 50%, #090a12 100%);
  }

  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:12px 12px;
    background: rgba(10,12,18,0.78);
    border-bottom: 1px solid rgba(255,255,255,0.10);
    backdrop-filter: blur(6px);
  }
  .brand{
    font-weight:1000;
    letter-spacing:0.7px;
    color:#7dffda;
    text-shadow: 0 0 18px rgba(125,255,218,0.30);
    font-size:14px;
    white-space:nowrap;
  }
  .meta{
    display:flex; align-items:center; gap:10px;
    font-size:12px;
    opacity:0.9;
    white-space:nowrap;
  }

  .pill{
    padding:6px 10px;
    border-radius:999px;
    background: rgba(255,255,255,0.08);
    border:1px solid rgba(255,255,255,0.12);
  }

  .main{
    flex:1;
    position:relative;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:14px;
  }

  /* stage card */
  .card{
    width:min(620px, 94vw);
    background: rgba(10,12,18,0.86);
    border:1px solid rgba(255,255,255,0.14);
    border-radius:22px;
    box-shadow: 0 18px 70px rgba(0,0,0,0.65);
    overflow:hidden;
  }

  .cardTop{
    padding:14px 14px 12px;
    display:flex;
    gap:12px;
    align-items:flex-start;
    border-bottom:1px solid rgba(255,255,255,0.10);
    background: linear-gradient(90deg, rgba(255,46,99,0.14), rgba(125,255,218,0.10));
  }

  .icon{
    width:52px; height:52px;
    border-radius:18px;
    display:grid;
    place-items:center;
    background: rgba(255,255,255,0.08);
    border:1px solid rgba(255,255,255,0.12);
    font-size:22px;
    flex: 0 0 auto;
  }

  .titleWrap{ min-width:0; }
  .stageTitle{
    font-weight:1000;
    letter-spacing:0.3px;
    font-size:15px;
    margin-bottom:4px;
    color:#ff2e63;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .stageSub{
    font-size:12px;
    opacity:0.85;
    line-height:1.25;
  }

  .cardBody{
    padding:14px;
  }

  .prompt{
    font-size:15px;
    line-height:1.38;
    white-space:pre-wrap;
    margin-bottom:12px;
  }

  .panel{
    background: rgba(255,255,255,0.06);
    border:1px solid rgba(255,255,255,0.12);
    border-radius:18px;
    padding:12px;
  }

  .row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }

  .input{
    flex:1;
    min-width: 180px;
    padding:12px 12px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,0.16);
    background: rgba(0,0,0,0.25);
    color:#eaf7ff;
    font-size:15px;
    font-weight:800;
    outline:none;
  }
  .input::placeholder{ opacity:0.55; }

  .btn{
    padding:12px 12px;
    border-radius:16px;
    border:none;
    font-weight:1000;
    cursor:pointer;
  }
  .btn.primary{
    background:#7dffda;
    color:#0b0d14;
  }
  .btn.secondary{
    background: rgba(255,255,255,0.10);
    color:#eaf7ff;
    border:1px solid rgba(255,255,255,0.16);
  }
  .btn.danger{
    background: rgba(255,46,99,0.22);
    border:1px solid rgba(255,46,99,0.38);
    color:#ffd6e7;
  }

  .choices{
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .choice{
    text-align:left;
    width:100%;
    padding:12px 12px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,0.16);
    background: rgba(255,255,255,0.07);
    color:#eaf7ff;
    font-weight:900;
  }

  .toast{
    margin-top:10px;
    font-size:13px;
    min-height:18px;
    opacity:0.92;
  }
  .toast.ok{ color:#7dffda; }
  .toast.no{ color:#ff86a9; }

  .cardFooter{
    padding:12px 14px 14px;
    border-top:1px solid rgba(255,255,255,0.10);
    display:flex;
    gap:10px;
  }

  /* journal drawer */
  .drawer{
    position:fixed;
    top:0; right:0; bottom:0;
    width:min(360px, 92vw);
    background: rgba(10,12,18,0.92);
    border-left:1px solid rgba(255,255,255,0.14);
    box-shadow: -20px 0 70px rgba(0,0,0,0.65);
    transform: translateX(105%);
    transition: transform 220ms ease;
    z-index:60;
    display:flex;
    flex-direction:column;
  }
  .drawer.open{ transform: translateX(0); }

  .drawerTop{
    padding:14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    border-bottom:1px solid rgba(255,255,255,0.10);
  }
  .drawerTitle{
    font-weight:1000;
    color:#7dffda;
    letter-spacing:0.6px;
  }
  .drawerBody{ padding:14px; overflow:auto; }
  .chipRow{ display:flex; flex-wrap:wrap; gap:8px; }
  .chip{
    padding:8px 10px;
    border-radius:999px;
    background: rgba(255,255,255,0.08);
    border:1px solid rgba(255,255,255,0.12);
    font-weight:1000;
    letter-spacing:0.3px;
  }
  .muted{
    opacity:0.75;
    font-size:12px;
    line-height:1.25;
    margin-top:10px;
  }

  /* final letter overlay */
  .overlay{
    position:fixed; inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    padding:18px;
    background: rgba(0,0,0,0.80);
    z-index:100;
  }
  .letterWrap{
    width:min(680px, 94vw);
    border-radius:26px;
    overflow:hidden;
    box-shadow: 0 22px 100px rgba(0,0,0,0.75);
    background: linear-gradient(180deg, #ffeef5, #ffd6e7);
    color:#3b1a27;
    border:1px solid rgba(255,255,255,0.65);
    position:relative;
  }
  .letterTop{
    padding:14px 16px;
    background: rgba(255,255,255,0.55);
    border-bottom:1px solid rgba(0,0,0,0.06);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .letterTitle{
    font-weight:1000;
    color:#ff4d8d;
    letter-spacing:0.4px;
  }
  .seal{
    font-weight:1000;
    color:#ff4d8d;
    background: rgba(255,77,141,0.14);
    border:1px solid rgba(255,77,141,0.35);
    padding:6px 10px;
    border-radius:999px;
    white-space:nowrap;
  }
  .paper{
    padding:16px 16px 18px;
    font-size:15px;
    line-height:1.5;
    white-space:pre-wrap;
  }
  .letterBtns{
    padding:14px 16px 16px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }
  .letterBtn{
    flex:1;
    min-width: 160px;
    padding:12px 12px;
    border-radius:18px;
    border:none;
    font-weight:1000;
  }
  .letterBtn.pink{
    background:#ff4d8d;
    color:white;
  }
  .letterBtn.soft{
    background: rgba(255,255,255,0.6);
    border:1px solid rgba(0,0,0,0.08);
    color:#3b1a27;
  }
  .heartsFX{
    position:absolute; inset:0;
    pointer-events:none;
    overflow:hidden;
  }
  .h{
    position:absolute;
    bottom:-20px;
    font-size:22px;
    opacity:0.0;
    animation: floatUp 2200ms ease-in forwards;
  }
  @keyframes floatUp{
    0%{ transform: translateY(0); opacity:0; }
    15%{ opacity:0.95; }
    100%{ transform: translateY(-420px); opacity:0; }
  }
</style>
</head>

<body>
<div id="app">
  <div class="topbar">
    <div class="brand">FINAL ACCESS // QUEST</div>
    <div class="meta">
      <div class="pill" id="progressPill">—ç—Ç–∞–ø 1/8</div>
      <button class="btn secondary" id="journalBtn" style="padding:8px 10px;border-radius:999px;">–∂—É—Ä–Ω–∞–ª</button>
    </div>
  </div>

  <div class="main">
    <div class="card" id="card">
      <div class="cardTop">
        <div class="icon" id="stageIcon">üîê</div>
        <div class="titleWrap">
          <div class="stageTitle" id="stageTitle">‚Äî</div>
          <div class="stageSub" id="stageSub">‚Äî</div>
        </div>
      </div>

      <div class="cardBody">
        <div class="prompt" id="prompt">‚Äî</div>

        <div class="panel" id="panel">
          <!-- dynamic -->
        </div>

        <div class="toast" id="toast"></div>
      </div>

      <div class="cardFooter">
        <button class="btn secondary" id="hintBtn">–ø–æ–¥—Å–∫–∞–∑–∫–∞</button>
        <button class="btn secondary" id="backBtn">–Ω–∞–∑–∞–¥</button>
        <button class="btn primary" id="nextBtn">–¥–∞–ª—å—à–µ</button>
      </div>
    </div>
  </div>
</div>

<!-- Journal drawer -->
<div class="drawer" id="drawer">
  <div class="drawerTop">
    <div class="drawerTitle">–ñ—É—Ä–Ω–∞–ª —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤</div>
    <button class="btn secondary" id="closeDrawerBtn" style="padding:8px 10px;border-radius:999px;">–∑–∞–∫—Ä—ã—Ç—å</button>
  </div>
  <div class="drawerBody">
    <div class="chipRow" id="chipRow"></div>
    <div class="muted" id="journalNote"></div>
  </div>
</div>

<!-- Final letter overlay -->
<div class="overlay" id="overlay">
  <div class="letterWrap">
    <div class="heartsFX" id="heartsFX"></div>
    <div class="letterTop">
      <div class="letterTitle">–ü–∏—Å—å–º–æ –¥–ª—è –ö–∏—Å—ã üíå</div>
      <div class="seal">–¥–æ—Å—Ç—É–ø –æ—Ç–∫—Ä—ã—Ç</div>
    </div>
    <div class="paper" id="paper"></div>
    <div class="letterBtns">
      <button class="letterBtn soft" id="rewriteBtn">–ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å</button>
      <button class="letterBtn pink" id="hugBtn">–æ–±–Ω—è—Ç—å –∫–æ—Ç—é</button>
      <button class="letterBtn soft" id="closeBtn">–∑–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<script>
/* =========================
   –¢–£–¢ –í–°–¢–ê–í–õ–Ø–ï–®–¨ –¢–í–û–Å –ü–û–ó–î–†–ê–í–õ–ï–ù–ò–ï
   (–º–æ–∂–Ω–æ –º–Ω–æ–≥–æ —Å—Ç—Ä–æ–∫, —Å –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏)
========================= */
const FINAL_MESSAGE = `
–ú–æ–π –ª—é–±–∏–º—ã–π –ö–∏—Å–∞!

–° –¥–Ω—ë–º —Ä–æ–∂–¥–µ–Ω–∏—è —Ç–µ–±—è! 20 –ª–µ—Ç ‚Äî —ç—Ç–æ –∑–≤—É—á–∏—Ç —Ç–∞–∫ —Å–µ—Ä—å—ë–∑–Ω–æ –∏ –≤ —Ç–æ –∂–µ –≤—Ä–µ–º—è –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ –¥–ª—è –º–µ–Ω—è —Ç—ã –≤—Å—ë —Ç–æ—Ç –∂–µ –º–æ–π –º–∞–ª—å—á–∏–∫, —Å –∫–æ—Ç–æ—Ä—ã–º –º—ã 29 —è–Ω–≤–∞—Ä—è 2024 –≥–æ–¥–∞ –≤–¥—Ä—É–≥ –ø–æ–Ω—è–ª–∏, —á—Ç–æ –≤—Å—ë, —ç—Ç–æ –Ω–∞–≤—Å–µ–≥–¥–∞. –£–∂–µ –±–æ–ª—å—à–µ –¥–≤—É—Ö –ª–µ—Ç —Ç—ã ‚Äî —Å–∞–º–∞—è –ª—É—á—à–∞—è —á–∞—Å—Ç—å –º–æ–µ–π –∂–∏–∑–Ω–∏.

–í–ø–µ—Ä–µ–¥–∏ —É –Ω–∞—Å –æ—á–µ–Ω—å –≤–∑—Ä–æ—Å–ª—ã–π –∏ –Ω–µ–ø—Ä–æ—Å—Ç–æ–π –≥–æ–¥. –Ø –∑–Ω–∞—é, –∫–∞–∫ –º—ã –æ–±–∞ –ø–∞—Ä–∏–º—Å—è –∏–∑-–∑–∞ —ç—Ç–æ–≥–æ –¥–∏–ø–ª–æ–º–∞, –∫–∞–∫–∏–µ —Ç–∞–º –±–µ—à–µ–Ω—ã–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –∏ –±–µ—Å—Å–æ–Ω–Ω—ã–µ –Ω–æ—á–∏. –ù–æ –º—ã —Å–ø—Ä–∞–≤–∏–º—Å—è, —è —Ä—è–¥–æ–º, —è –±—É–¥—É –∑–∞–≤–∞—Ä–∏–≤–∞—Ç—å —Ç–µ–±–µ —á–∞–π, –≥–ª–∞–¥–∏—Ç—å –ø–æ –≥–æ–ª–æ–≤–µ, –∫–æ–≥–¥–∞ —Ç—ã —É—Å—Ç–∞–Ω–µ—à—å, –∏ –≤–µ—Ä–∏—Ç—å –≤ —Ç–µ–±—è –±–æ–ª—å—à–µ –≤—Å–µ—Ö –Ω–∞ —Å–≤–µ—Ç–µ. –ú—ã –≤—ã–≤–µ–∑–µ–º —ç—Ç—É —Å–µ—Å—Å–∏—é –∏ –∑–∞—â–∏—Ç—É, –∏ —è –±—É–¥—É —Ç–∞–∫ —Ç–æ–±–æ–π –≥–æ—Ä–¥–∏—Ç—å—Å—è!

–ê –ø–æ—Ç–æ–º... –ü–æ—Ç–æ–º –ø—Ä–∏–¥—ë—Ç –≤—Ä–µ–º—è, –∫–æ—Ç–æ—Ä–æ–≥–æ —è –±–æ—é—Å—å, –Ω–æ –∑–Ω–∞—é, —á—Ç–æ –æ–Ω–æ –Ω–µ–∏–∑–±–µ–∂–Ω–æ. –ö–æ–≥–¥–∞ —Ç—ã —É–π–¥—ë—à—å –≤ –∞—Ä–º–∏—é, –≤ –¥–æ–º–µ —Å—Ç–∞–Ω–µ—Ç –Ω–µ–≤—ã–Ω–æ—Å–∏–º–æ —Ç–∏—Ö–æ. –Ø –±—É–¥—É –∫–∞–∂–¥—ã–π –≤–µ—á–µ—Ä —Å–≤–æ—Ä–∞—á–∏–≤–∞—Ç—å—Å—è –∫–∞–ª–∞—á–∏–∫–æ–º –Ω–∞ —Ç–≤–æ–µ–π –ø–æ–¥—É—à–∫–µ, –ø–µ—Ä–µ—á–∏—Ç—ã–≤–∞—Ç—å –Ω–∞—à–∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –∏ —Å —É–º–∞ —Å—Ö–æ–¥–∏—Ç—å –æ—Ç —Ç–æ–≥–æ, —á—Ç–æ —Ç–µ–±—è –Ω–µ—Ç —Ä—è–¥–æ–º. –ù–æ —è –±—É–¥—É –∂–¥–∞—Ç—å, –±—É–¥—É —Å—á–∏—Ç–∞—Ç—å –¥–Ω–∏ –¥–æ —Ç–≤–æ–µ–≥–æ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è –∏ –Ω–∏ –Ω–∞ —Å–µ–∫—É–Ω–¥—É –Ω–µ —É—Å–æ–º–Ω—é—Å—å –≤ —Ç–æ–º, —á—Ç–æ –º—ã ‚Äî —ç—Ç–æ –Ω–∞–≤—Å–µ–≥–¥–∞.

–¢—ã ‚Äî –º–æ–π —Å–∞–º—ã–π —Ä–æ–¥–Ω–æ–π —á–µ–ª–æ–≤–µ–∫, –º–æ—è —Ä–∞–¥–æ—Å—Ç—å –∏ –º–æ—ë —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ. –°–ø–∞—Å–∏–±–æ —Ç–µ–±–µ –∑–∞ —Ç–≤–æ—é –∑–∞–±–æ—Ç—É, –∑–∞ —Ç–≤–æ–π —Å–º–µ—Ö –∏ –∑–∞ —Ç–æ, –∫–∞–∫ —Ç—ã —Å–º–æ—Ç—Ä–∏—à—å –Ω–∞ –º–µ–Ω—è.

–° –¥–Ω—ë–º —Ä–æ–∂–¥–µ–Ω–∏—è, –º–æ—è –ö–∏—Å–∞ –ë—É–¥—å –∑–¥–æ—Ä–æ–≤, —Å—á–∞—Å—Ç–ª–∏–≤ –∏ –∑–Ω–∞–π: —è —Ç–µ–±—è –æ—á–µ–Ω—å-–æ—á–µ–Ω—å –ª—é–±–ª—é.
`;

/* =========================
   –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –ø—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –∏–≥—Ä—ã –ø—Ä–æ–π–¥–µ–Ω—ã
========================= */
const REQUIRED_FLAGS = [
  ["game1Complete", "–ì–æ–Ω–∫–∞ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞ (game1)."],
  ["game2Complete", "–ö–æ—Ç–∏–∫–∏ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã (game2)."],
  ["game3Complete", "–ù–æ–≤–µ–ª–ª–∞ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞ (game3)."]
];

function checkRequired(){
  for (const [k, msg] of REQUIRED_FLAGS){
    if (localStorage.getItem(k) !== "true"){
      return msg;
    }
  }
  return null;
}

/* =========================
   –î–∞–Ω–Ω—ã–µ –∫–≤–µ—Å—Ç–∞
========================= */
const QUEST_KEY = "questState_v1";
const FRAG_KEY  = "questFrags_v1";

/* –§–ò–ù–ê–õ–¨–ù–´–ô –ö–û–î (–æ–Ω –≤–≤–æ–¥–∏—Ç —Å–∞–º) */
const FINAL_CODE = "9423ACO";

/* –≠—Ç–∞–ø—ã (8, –∫–∞–∫ —Ç—ã —Ö–æ—Ç–µ–ª–∞) */
const STAGES = [
  {
    id:"date",
    icon:"üìÖ",
    title:"–≠—Ç–∞–ø 1 ‚Äî –î–∞—Ç–∞ –¥–æ—Å—Ç—É–ø–∞",
    sub:"–¢–µ–º–∞: –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ // –ª–æ–≥–∏–∫–∞",
    prompt:
`29.01.2024

–°–∏—Å—Ç–µ–º–∞: ¬´–ü—Ä–µ–≤—Ä–∞—Ç–∏ –¥–∞—Ç—É –≤ –æ–¥–∏–Ω —Å–∏–º–≤–æ–ª.¬ª`,
    type:"input",
    placeholder:"–≤–≤–µ–¥–∏ –æ–¥–Ω—É —Ü–∏—Ñ—Ä—É",
    validate:(v)=> v === "9",
    hint:[
      "–ü–æ–¥—Å–∫–∞–∑–∫–∞ 1: –≤–æ–∑—å–º–∏ —Ñ–æ—Ä–º–∞—Ç –î–î–ú–ú–ì–ì (29 01 24).",
      "–ü–æ–¥—Å–∫–∞–∑–∫–∞ 2: —Å–ª–æ–∂–∏ –≤—Å–µ —Ü–∏—Ñ—Ä—ã 2+9+0+1+2+4=18, –∑–∞—Ç–µ–º 1+8=9."
    ],
    onPass:(frags)=> frags.date = "9"
  },
  {
    id:"plate",
    icon:"üöò",
    title:"–≠—Ç–∞–ø 2 ‚Äî –ù–æ–º–µ—Ä –Ω–∞ –¥–æ—Ä–æ–≥–µ",
    sub:"–¢–µ–º–∞: –º–∞—à–∏–Ω–∞ // —à–∏—Ñ—Ä –±—É–∫–≤",
    prompt:
`–ï972–ú–¢

–°–∏—Å—Ç–µ–º–∞: ¬´–ë—É–∫–≤—ã ‚Äî —Ç–æ–∂–µ —á–∏—Å–ª–∞. –î–∞–π –æ–¥–∏–Ω —Å–∏–º–≤–æ–ª.¬ª`,
    type:"input",
    placeholder:"–≤–≤–µ–¥–∏ –æ–¥–Ω—É —Ü–∏—Ñ—Ä—É",
    validate:(v)=> v === "4",
    hint:[
      "–ü–æ–¥—Å–∫–∞–∑–∫–∞ 1: –≤–æ–∑—å–º–∏ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã E M T (–∫–∞–∫ –Ω–∞ –Ω–æ–º–µ—Ä–∞—Ö).",
      "–ü–æ–¥—Å–∫–∞–∑–∫–∞ 2: A1Z26: E=5, M=13, T=20. 5+13+20=38. –ü–µ—Ä–≤—É—é —Ü–∏—Ñ—Ä—É –≤–æ–∑—å–º–∏: 3(8) ‚Üí 4 –º—ã –ø–æ–ª—É—á–∞–µ–º —Ç–∞–∫: 38+9(–∏–∑ —ç—Ç–∞–ø–∞ 1)=47, –ø–µ—Ä–≤–∞—è —Ü–∏—Ñ—Ä–∞ 4."
    ],
    onPass:(frags)=> frags.plate = "4"
  },
  {
    id:"house",
    icon:"üè†",
    title:"–≠—Ç–∞–ø 3 ‚Äî –ê–¥—Ä–µ—Å-–∫–ª—é—á",
    sub:"–¢–µ–º–∞: –¥–æ–º // –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å",
    prompt:
`9/2

–°–∏—Å—Ç–µ–º–∞: ¬´–ù–µ –¥–µ–ª–∏. –°–æ–µ–¥–∏–Ω–∏.¬ª`,
    type:"input",
    placeholder:"–≤–≤–µ–¥–∏ –æ–¥–Ω—É —Ü–∏—Ñ—Ä—É",
    validate:(v)=> v === "2",
    hint:[
      "–ü–æ–¥—Å–∫–∞–∑–∫–∞ 1: —ç—Ç–æ –Ω–µ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞.",
      "–ü–æ–¥—Å–∫–∞–∑–∫–∞ 2: ¬´—Å–æ–µ–¥–∏–Ω–∏¬ª ‚Üí –ø–æ–ª—É—á–∞–µ–º 92. –ù—É–∂–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è —Ü–∏—Ñ—Ä–∞: 2."
    ],
    onPass:(frags)=> frags.house = "2"
  },
  {
    id:"kazan",
    icon:"üåÜ",
    title:"–≠—Ç–∞–ø 4 ‚Äî –ì–æ—Ä–æ–¥ –Ω–∞—á–∞–ª–∞",
    sub:"–¢–µ–º–∞: –ö–∞–∑–∞–Ω—å // –±—É–∫–≤—ã",
    prompt:
`–ö–ê–ó–ê–ù–¨

–°–∏—Å—Ç–µ–º–∞: ¬´–°–∫–æ–ª—å–∫–æ –∑–¥–µ—Å—å —Å–æ–≥–ª–∞—Å–Ω—ã—Ö?¬ª`,
    type:"input",
    placeholder:"–≤–≤–µ–¥–∏ –æ–¥–Ω—É —Ü–∏—Ñ—Ä—É",
    validate:(v)=> v === "3",
    hint:[
      "–ü–æ–¥—Å–∫–∞–∑–∫–∞ 1: —Å—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–≥–ª–∞—Å–Ω—ã–µ.",
      "–ü–æ–¥—Å–∫–∞–∑–∫–∞ 2: –ö, –ó, –ù = 3. (–¨ –Ω–µ —Å—á–∏—Ç–∞–µ–º –∫–∞–∫ —Å–æ–≥–ª–∞—Å–Ω—É—é.)"
    ],
    onPass:(frags)=> frags.city = "3"
  },
  {
    id:"aot",
    icon:"‚öîÔ∏è",
    title:"–≠—Ç–∞–ø 5 ‚Äî –°–∏–ª–∞ —É–º–∞",
    sub:"–¢–µ–º–∞: Attack on Titan // –≤—ã–±–æ—Ä",
    prompt:
`–ö—Ç–æ —á–∞—â–µ –¥—É–º–∞–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏, –∞ –Ω–µ –∏–º–ø—É–ª—å—Å–∏–≤–Ω–æ?`,
    type:"choice",
    choices:[
      { label:"–≠—Ä–µ–Ω", ok:false },
      { label:"–õ–µ–≤–∏", ok:false },
      { label:"–ê—Ä–º–∏–Ω", ok:true }
    ],
    hint:[
      "–ü–æ–¥—Å–∫–∞–∑–∫–∞ 1: –æ–Ω —á–∞—Å—Ç–æ –ø—Ä–æ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏ –æ–±—ä—è—Å–Ω—è–µ—Ç –ø–ª–∞–Ω.",
      "–ü–æ–¥—Å–∫–∞–∑–∫–∞ 2: —ç—Ç–æ –ê—Ä–º–∏–Ω."
    ],
    onPass:(frags)=> frags.aot = "A"
  },
  {
    id:"initiald",
    icon:"üõû",
    title:"–≠—Ç–∞–ø 6 ‚Äî –ù–æ—á–Ω–∞—è —Ç—Ä–∞—Å—Å–∞",
    sub:"–¢–µ–º–∞: Initial D // –ø—Ä–∏–Ω—Ü–∏–ø",
    prompt:
`–ß—Ç–æ –≤–∞–∂–Ω–µ–µ –¥–ª—è –ø–æ–±–µ–¥—ã –≤ –Ω–æ—á–Ω–æ–π –≥–æ–Ω–∫–µ?`,
    type:"choice",
    choices:[
      { label:"–ú–æ—â–Ω–æ—Å—Ç—å", ok:false },
      { label:"–ö–æ–Ω—Ç—Ä–æ–ª—å", ok:true },
      { label:"–†–∏—Å–∫", ok:false }
    ],
    hint:[
      "–ü–æ–¥—Å–∫–∞–∑–∫–∞ 1: —ç—Ç–æ –Ω–µ –ø—Ä–æ ¬´—Å–∞–º—ã–π –≥—Ä–æ–º–∫–∏–π –º–æ—Ç–æ—Ä¬ª.",
      "–ü–æ–¥—Å–∫–∞–∑–∫–∞ 2: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç ‚Äî –ö–æ–Ω—Ç—Ä–æ–ª—å."
    ],
    onPass:(frags)=> frags.initiald = "C"
  },
  {
    id:"hug",
    icon:"üíó",
    title:"–≠—Ç–∞–ø 7 ‚Äî –°–∞–º–æ–µ –≥–ª–∞–≤–Ω–æ–µ",
    sub:"–¢–µ–º–∞: –≤—ã –≤–¥–≤–æ—ë–º // —Å–ª–æ–≤–æ",
    prompt:
`–í —Ç—É –Ω–æ—á—å‚Ä¶ —á—Ç–æ –æ–∫–∞–∑–∞–ª–æ—Å—å –≤–∞–∂–Ω–µ–µ —Å–ª–æ–≤?

(–æ–¥–Ω–æ —Å–ª–æ–≤–æ)`,
    type:"input",
    placeholder:"–Ω–∞–ø—Ä–∏–º–µ—Ä: ...",
    validate:(v)=> {
      const s = (v||"").trim().toLowerCase();
      return s === "–æ–±—ä—è—Ç–∏—è" || s === "–æ–±–Ω–∏–º–∫—É" || s === "–æ–±–Ω–∏–º–∫—É." || s === "–æ–±–Ω–∏–º–∞—à–∫–∏";
    },
    hint:[
      "–ü–æ–¥—Å–∫–∞–∑–∫–∞ 1: —ç—Ç–æ –ø—Ä–æ —Ç–µ–ø–ª–æ, –∞ –Ω–µ –ø—Ä–æ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã.",
      "–ü–æ–¥—Å–∫–∞–∑–∫–∞ 2: –ø–æ–¥–æ–π–¥—ë—Ç ¬´–æ–±—ä—è—Ç–∏—è¬ª (–∏ –±–ª–∏–∑–∫–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã)."
    ],
    onPass:(frags)=> frags.love = "O"
  },
  {
    id:"final",
    icon:"üîë",
    title:"–≠—Ç–∞–ø 8 ‚Äî –§–∏–Ω–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø",
    sub:"–¢–µ–º–∞: —Å–±–æ—Ä–∫–∞ –∫–ª—é—á–∞ // –≤–≤–æ–¥",
    prompt:
`–°–æ–±–µ—Ä–∏ –∫–æ–¥.

–ü—Ä–∞–≤–∏–ª–æ:
1) –¶–∏—Ñ—Ä—ã –∏–¥—É—Ç –ø–µ—Ä–≤—ã–º–∏.
2) –ü–æ—Ç–æ–º –±—É–∫–≤—ã –ø–æ –ø–æ—Ä—è–¥–∫—É –ø–æ—è–≤–ª–µ–Ω–∏—è (–≤ –∂—É—Ä–Ω–∞–ª–µ).
3) –í–≤–µ–¥–∏ –∏—Ç–æ–≥–æ–≤—ã–π –∫–æ–¥ –∏ –æ—Ç–∫—Ä–æ–π –ø–∏—Å—å–º–æ.`,
    type:"finalInput",
    placeholder:"–≤–≤–µ–¥–∏ –∫–æ–¥",
    validate:(v)=> (v||"").trim().toUpperCase() === FINAL_CODE,
    hint:[
      "–ü–æ–¥—Å–∫–∞–∑–∫–∞ 1: —É —Ç–µ–±—è –¥–æ–ª–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å—Å—è 7 —Å–∏–º–≤–æ–ª–æ–≤.",
      "–ü–æ–¥—Å–∫–∞–∑–∫–∞ 2: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–¥: 9423ACO"
    ],
    onPass:(frags)=> frags.final = "‚úÖ"
  }
];

/* =========================
   UI refs
========================= */
const progressPill = document.getElementById("progressPill");
const stageIcon = document.getElementById("stageIcon");
const stageTitle = document.getElementById("stageTitle");
const stageSub = document.getElementById("stageSub");
const promptEl = document.getElementById("prompt");
const panel = document.getElementById("panel");
const toast = document.getElementById("toast");

const hintBtn = document.getElementById("hintBtn");
const backBtn = document.getElementById("backBtn");
const nextBtn = document.getElementById("nextBtn");

const journalBtn = document.getElementById("journalBtn");
const drawer = document.getElementById("drawer");
const closeDrawerBtn = document.getElementById("closeDrawerBtn");
const chipRow = document.getElementById("chipRow");
const journalNote = document.getElementById("journalNote");

const overlay = document.getElementById("overlay");
const paper = document.getElementById("paper");
const rewriteBtn = document.getElementById("rewriteBtn");
const hugBtn = document.getElementById("hugBtn");
const closeBtn = document.getElementById("closeBtn");
const heartsFX = document.getElementById("heartsFX");

/* =========================
   State
========================= */
let state = { i: 0, hintLevel: 0 };
let frags = {
  // –±—É–¥–µ–º —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∫—É—Å–æ—á–∫–∏ (–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤ –∂—É—Ä–Ω–∞–ª–µ)
  date:null, plate:null, house:null, city:null, aot:null, initiald:null, love:null, final:null
};

function load(){
  const rawS = localStorage.getItem(QUEST_KEY);
  if(rawS){
    try{ state = JSON.parse(rawS); }catch(e){}
  }
  const rawF = localStorage.getItem(FRAG_KEY);
  if(rawF){
    try{ frags = JSON.parse(rawF); }catch(e){}
  }
}
function save(){
  localStorage.setItem(QUEST_KEY, JSON.stringify(state));
  localStorage.setItem(FRAG_KEY, JSON.stringify(frags));
}
load();

/* =========================
   Journal
========================= */
function openJournal(){
  renderJournal();
  drawer.classList.add("open");
}
function closeJournal(){
  drawer.classList.remove("open");
}
function renderJournal(){
  chipRow.innerHTML = "";

  const items = [
    ["–î–∞—Ç–∞", frags.date],
    ["–ù–æ–º–µ—Ä", frags.plate],
    ["–î–æ–º", frags.house],
    ["–ì–æ—Ä–æ–¥", frags.city],
    ["AoT", frags.aot],
    ["Initial D", frags.initiald],
    ["–¢–µ–ø–ª–æ", frags.love],
  ];

  items.forEach(([k, v])=>{
    const d = document.createElement("div");
    d.className = "chip";
    d.textContent = v ? `${k}: ${v}` : `${k}: ‚Äî`;
    chipRow.appendChild(d);
  });

  // –ø–æ–∫–∞–∂–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–æ –∫–æ–¥—ã –∏–≥—Ä (–µ—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ ‚Äú–ø—Ä–∏—è—Ç–Ω–æ‚Äù)
  const s0 = localStorage.getItem("game1Complete")==="true" ? "S0" : "‚Äî";
  const c4 = localStorage.getItem("game2Complete")==="true" ? "C4" : "‚Äî";
  const h1 = localStorage.getItem("game3Complete")==="true" ? "H1" : "‚Äî";

  journalNote.textContent =
    `–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –∫–æ–¥—ã –∏–≥—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
–ì–æ–Ω–∫–∞: ${s0} ‚Ä¢ –ö–æ—Ç–∏–∫–∏: ${c4} ‚Ä¢ –ù–æ–≤–µ–ª–ª–∞: ${h1}
(–æ–Ω–∏ –Ω–µ –Ω—É–∂–Ω—ã –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ ‚Äú–ø–∞–º—è—Ç—å –ø—É—Ç–∏‚Äù)`;
}

/* =========================
   Render stage
========================= */
function setToast(msg, ok){
  toast.textContent = msg || "";
  toast.classList.remove("ok","no");
  if(!msg) return;
  toast.classList.add(ok ? "ok" : "no");
}

function render(){
  const need = checkRequired();
  if(need){
    // –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ –æ—Ç–∫—Ä—ã–ª quest –Ω–∞–ø—Ä—è–º—É—é
    stageIcon.textContent = "‚õî";
    stageTitle.textContent = "–î–æ—Å—Ç—É–ø –∑–∞–∫—Ä—ã—Ç";
    stageSub.textContent = "–í–µ—Ä–Ω–∏—Å—å –∏ –ø—Ä–æ–π–¥–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —É—Ä–æ–≤–Ω–∏";
    promptEl.textContent = need + "\n\n(–û—Ç–∫—Ä–æ–π index.html –∏ –ø—Ä–æ–π–¥–∏ —Ü–µ–ø–æ—á–∫—É –∏–≥—Ä.)";
    panel.innerHTML = `<div class="muted">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –µ—Å–ª–∏ —Ç—ã —Ç–µ—Å—Ç–∏—Ä—É–µ—à—å ‚Äî –º–æ–∂–µ—à—å –≤—Ä–µ–º–µ–Ω–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –≤ localStorage —Ñ–ª–∞–≥–∏ game1Complete/game2Complete/game3Complete=true.</div>`;
    hintBtn.disabled = true;
    backBtn.disabled = true;
    nextBtn.disabled = true;
    setToast("", true);
    return;
  }

  const stage = STAGES[state.i];
  progressPill.textContent = `—ç—Ç–∞–ø ${state.i+1}/${STAGES.length}`;

  stageIcon.textContent = stage.icon;
  stageTitle.textContent = stage.title;
  stageSub.textContent = stage.sub;
  promptEl.textContent = stage.prompt;

  // reset hint level for a new stage
  state.hintLevel = 0;
  save();

  // navigation
  backBtn.disabled = state.i === 0;
  nextBtn.disabled = stage.type !== "finalInput"; // –≤ —Ñ–∏–Ω–∞–ª–µ –∫–Ω–æ–ø–∫–∞ "–¥–∞–ª—å—à–µ" –Ω–µ –Ω—É–∂–Ω–∞, –æ–Ω –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–∏—Å—å–º–æ–º
  nextBtn.textContent = (stage.type === "finalInput") ? "‚Äî" : "–¥–∞–ª—å—à–µ";

  // build panel
  panel.innerHTML = "";
  setToast("", true);

  if(stage.type === "input" || stage.type === "finalInput"){
    const wrap = document.createElement("div");
    wrap.className = "row";

    const inp = document.createElement("input");
    inp.className = "input";
    inp.placeholder = stage.placeholder || "";
    inp.autocomplete = "off";
    inp.autocapitalize = "none";
    inp.spellcheck = false;
    inp.id = "answerInput";

    const btn = document.createElement("button");
    btn.className = "btn primary";
    btn.textContent = (stage.type === "finalInput") ? "–æ—Ç–∫—Ä—ã—Ç—å –ø–∏—Å—å–º–æ" : "–ø—Ä–æ–≤–µ—Ä–∏—Ç—å";

    btn.onclick = () => {
      const v = (inp.value || "").trim();
      if(stage.validate(v)){
        setToast("‚úÖ –í–µ—Ä–Ω–æ. –§—Ä–∞–≥–º–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –∂—É—Ä–Ω–∞–ª.", true);
        stage.onPass && stage.onPass(frags);
        save();

        if(stage.id === "final"){
          openLetter();
          return;
        }

        setTimeout(()=>{ goNext(); }, 650);
      } else {
        setToast("‚ùå –ù–µ–≤–µ—Ä–Ω–æ. –í–æ–∑—å–º–∏ –ø–æ–¥—Å–∫–∞–∑–∫—É, —Ç—É—Ç –≤—Å—ë —á–µ—Å—Ç–Ω–æ –∏ –ª–æ–≥–∏—á–Ω–æ.", false);
        // –ª—ë–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ
        if(navigator.vibrate) navigator.vibrate(30);
      }
    };

    // enter key
    inp.addEventListener("keydown", (e)=>{
      if(e.key === "Enter") btn.click();
    });

    wrap.appendChild(inp);
    wrap.appendChild(btn);
    panel.appendChild(wrap);

    const tiny = document.createElement("div");
    tiny.className = "muted";
    tiny.textContent = (stage.type === "finalInput")
      ? "–ü–æ–¥—Å–∫–∞–∑–∫–∞: –æ—Ç–∫—Ä–æ–π ¬´–∂—É—Ä–Ω–∞–ª¬ª ‚Äî —Ç–∞–º –≤—Å–µ –∫—É—Å–æ—á–∫–∏."
      : "–ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä—ë–Ω ‚Äî –Ω–∞–∂–º–∏ ¬´–ø–æ–¥—Å–∫–∞–∑–∫–∞¬ª (–∏—Ö –¥–≤–µ, –≤—Å—ë —Å—Ç–∞–Ω–µ—Ç —è—Å–Ω–æ).";
    panel.appendChild(tiny);
  }

  if(stage.type === "choice"){
    const wrap = document.createElement("div");
    wrap.className = "choices";

    stage.choices.forEach(ch=>{
      const b = document.createElement("button");
      b.className = "choice";
      b.textContent = ch.label;
      b.onclick = () => {
        if(ch.ok){
          setToast("‚úÖ –í–µ—Ä–Ω–æ. –§—Ä–∞–≥–º–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –∂—É—Ä–Ω–∞–ª.", true);
          stage.onPass && stage.onPass(frags);
          save();
          setTimeout(()=>{ goNext(); }, 650);
        }else{
          setToast("‚ùå –ù–µ —Ç–æ. –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ–º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É.", false);
          if(navigator.vibrate) navigator.vibrate(30);
        }
      };
      wrap.appendChild(b);
    });

    panel.appendChild(wrap);

    const tiny = document.createElement("div");
    tiny.className = "muted";
    tiny.textContent = "–ü–æ–¥—Å–∫–∞–∑–∫–∞: –≤ —ç—Ç–æ–º —ç—Ç–∞–ø–µ –µ—Å—Ç—å 2 —É—Ä–æ–≤–Ω—è –ø–æ–¥—Å–∫–∞–∑–∫–∏.";
    panel.appendChild(tiny);
  }

  // hint button
  hintBtn.disabled = false;
  hintBtn.textContent = "–ø–æ–¥—Å–∫–∞–∑–∫–∞";
}

/* =========================
   Navigation
========================= */
function goNext(){
  if(state.i < STAGES.length-1){
    state.i++;
    save();
    render();
  }
}
function goBack(){
  if(state.i > 0){
    state.i--;
    save();
    render();
  }
}

/* =========================
   Hints
========================= */
hintBtn.onclick = () => {
  const stage = STAGES[state.i];
  const hints = stage.hint || [];
  if(!hints.length) return;

  const lvl = state.hintLevel;
  const msg = hints[Math.min(lvl, hints.length-1)];
  state.hintLevel = Math.min(lvl+1, hints.length-1);
  save();

  setToast("üí° " + msg, true);
};

backBtn.onclick = goBack;
nextBtn.onclick = goNext;

journalBtn.onclick = openJournal;
closeDrawerBtn.onclick = closeJournal;
drawer.addEventListener("click", (e)=>{
  if(e.target === drawer) closeJournal();
});

/* =========================
   Final Letter
========================= */
function openLetter(){
  overlay.style.display = "flex";
  paper.textContent = FINAL_MESSAGE.trim();
}
function closeLetter(){
  overlay.style.display = "none";
}

/* ‚Äú–ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å‚Äù ‚Äî –ø—Ä–æ—Å—Ç–æ –∑–∞–Ω–æ–≤–æ –∫—Ä–∞—Å–∏–≤–æ ‚Äú–ø–µ—Ä–µ—á–∏—Ç–∞—Ç—å‚Äù */
rewriteBtn.onclick = () => {
  paper.textContent = "";
  const text = FINAL_MESSAGE.trim();
  let i = 0;
  const tick = () => {
    i++;
    paper.textContent = text.slice(0, i);
    if(i < text.length) setTimeout(tick, 10);
  };
  tick();
};

/* ‚Äú–æ–±–Ω—è—Ç—å –∫–æ—Ç—é‚Äù ‚Äî —Å–µ—Ä–¥–µ—á–∫–∏ + –≤–∏–±—Ä–∞—Ü–∏—è + –º—É—Ä—á–∞–Ω–∏–µ (WebAudio) */
function purr(){
  try{
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioCtx();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "sine";
    o.frequency.value = 70;
    g.gain.value = 0.0001;

    o.connect(g); g.connect(ctx.destination);
    o.start();

    // –ø–ª–∞–≤–Ω–æ –≥—Ä–æ–º—á–µ-—Ç–∏—à–µ –∫–∞–∫ –º—É—Ä
    const now = ctx.currentTime;
    g.gain.exponentialRampToValueAtTime(0.05, now + 0.08);
    g.gain.exponentialRampToValueAtTime(0.01, now + 0.6);
    g.gain.exponentialRampToValueAtTime(0.05, now + 1.1);
    g.gain.exponentialRampToValueAtTime(0.0001, now + 1.6);

    setTimeout(()=>{ o.stop(); ctx.close(); }, 1700);
  }catch(e){}
}

function heartsBurst(){
  for(let k=0;k<18;k++){
    const el = document.createElement("div");
    el.className = "h";
    el.textContent = (Math.random() < 0.5) ? "üíó" : "üíï";
    el.style.left = (8 + Math.random()*84) + "%";
    el.style.animationDelay = (Math.random()*180) + "ms";
    el.style.fontSize = (18 + Math.random()*14) + "px";
    heartsFX.appendChild(el);
    setTimeout(()=>el.remove(), 2500);
  }
}

hugBtn.onclick = () => {
  heartsBurst();
  if(navigator.vibrate) navigator.vibrate([30,30,30]);
  purr();
};

closeBtn.onclick = closeLetter;
overlay.addEventListener("click", (e)=>{
  if(e.target === overlay) closeLetter();
});

/* =========================
   Start render
========================= */
render();
</script>
</body>
</html>